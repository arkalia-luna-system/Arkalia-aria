name: ğŸ“š Deploy Documentation - GitHub Pages

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "deploy-docs-${{ github.ref }}"
  cancel-in-progress: true

# Workflow indÃ©pendant du CI/CD - peut s'exÃ©cuter en parallÃ¨le
# Note: Ce workflow a une prioritÃ© plus basse et ne bloque pas le CI/CD

jobs:
  build-docs:
    name: ğŸ“š Build Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: ğŸ“¦ Install Documentation Dependencies
        timeout-minutes: 5
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material mkdocs-mermaid2-plugin mkdocs-git-revision-date-plugin

      - name: ğŸ“š Build Documentation
        timeout-minutes: 10
        continue-on-error: true
        run: |
          echo "ğŸ“š Building documentation with MkDocs..."
          mkdocs build --clean --strict || (echo "âš ï¸ Documentation build completed with warnings" && exit 0)

      - name: ğŸ§¹ Nettoyer rÃ©pertoire site
        if: always()
        run: |
          if [ -d "site" ]; then
            echo "ğŸ§¹ Nettoyage approfondi du rÃ©pertoire site..."
            # Supprimer tous les liens symboliques rÃ©cursivement
            find site -type l -print0 | xargs -0 rm -f 2>/dev/null || true
            # Supprimer les fichiers cachÃ©s
            find site -name ".*" -type f -delete 2>/dev/null || true
            find site -name ".*" -type d -exec rm -rf {} + 2>/dev/null || true
            # Supprimer les liens physiques (hard links) - copier les fichiers Ã  la place
            find site -type f -links +1 -exec sh -c 'cp "$1" "$1.tmp" && mv "$1.tmp" "$1"' _ {} \; 2>/dev/null || true
            # VÃ©rifier qu'il ne reste plus de liens
            SYMLINKS=$(find site -type l | wc -l)
            if [ "$SYMLINKS" -gt 0 ]; then
              echo "âš ï¸ Attention: $SYMLINKS liens symboliques restants"
              find site -type l -ls
            fi
            # VÃ©rifier la taille
            SIZE=$(du -sh site | cut -f1)
            echo "ğŸ“Š Taille du rÃ©pertoire site: $SIZE"
            # VÃ©rifier que la taille est raisonnable (< 1GB)
            SIZE_BYTES=$(du -sb site | cut -f1)
            if [ "$SIZE_BYTES" -gt 1073741824 ]; then
              echo "âš ï¸ Attention: Taille supÃ©rieure Ã  1GB ($SIZE_BYTES bytes)"
            fi
            echo "âœ… Nettoyage terminÃ©"
          fi

      - name: ğŸ“¤ Upload GitHub Pages artifact
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: github-pages
          path: site/
          retention-days: 1
          if-no-files-found: warn
          compression-level: 6

  deploy-docs:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build-docs]
    if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 10
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: ğŸ“¥ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: github-pages
          path: ./site

      - name: ğŸ” VÃ©rifier contenu artefact
        run: |
          echo "ğŸ“‚ VÃ©rification du contenu tÃ©lÃ©chargÃ©..."
          if [ -d "site" ]; then
            echo "âœ… RÃ©pertoire site trouvÃ©"
            echo "ğŸ“Š Contenu:"
            ls -la site/ | head -15
            echo ""
            echo "ğŸ“Š Taille:"
            du -sh site
          else
            echo "âš ï¸ RÃ©pertoire site non trouvÃ©, vÃ©rification du contenu courant..."
            ls -la | head -20
            # Si l'artefact a Ã©tÃ© tÃ©lÃ©chargÃ© directement Ã  la racine (sans rÃ©pertoire site)
            if [ -f "index.html" ] || [ -d "assets" ]; then
              echo "ğŸ“¦ Le contenu du site est Ã  la racine, crÃ©ation du rÃ©pertoire site..."
              mkdir -p site
              # DÃ©placer tous les fichiers et rÃ©pertoires (sauf .git, site lui-mÃªme, etc.)
              for item in * .[!.]*; do
                if [ "$item" != "site" ] && [ "$item" != ".git" ] && [ -e "$item" ]; then
                  mv "$item" site/
                fi
              done
              echo "âœ… Contenu dÃ©placÃ© dans site/"
            else
              echo "âŒ ERREUR: Impossible de trouver le contenu du site"
              exit 1
            fi
          fi

      - name: ğŸ§¹ VÃ©rification et nettoyage final avant dÃ©ploiement
        run: |
          if [ ! -d "site" ]; then
            echo "âŒ ERREUR: RÃ©pertoire site introuvable aprÃ¨s traitement"
            exit 1
          fi

          echo "ğŸ” VÃ©rification finale avant dÃ©ploiement..."
          # VÃ©rifier les liens symboliques
          SYMLINKS=$(find site -type l 2>/dev/null | wc -l)
          if [ "$SYMLINKS" -gt 0 ]; then
            echo "âš ï¸ $SYMLINKS liens symboliques trouvÃ©s - suppression..."
            find site -type l -print0 | xargs -0 rm -f
          fi
          # VÃ©rifier les liens physiques
          HARD_LINKS=$(find site -type f -links +1 2>/dev/null | wc -l)
          if [ "$HARD_LINKS" -gt 0 ]; then
            echo "âš ï¸ $HARD_LINKS fichiers avec liens physiques - conversion..."
            find site -type f -links +1 -exec sh -c 'cp "$1" "$1.tmp" && mv "$1.tmp" "$1"' _ {} \;
          fi
          # VÃ©rifier la taille
          SIZE=$(du -sh site | cut -f1)
          SIZE_BYTES=$(du -sb site | cut -f1)
          echo "ğŸ“Š Taille finale: $SIZE ($SIZE_BYTES bytes)"
          if [ "$SIZE_BYTES" -gt 10737418240 ]; then
            echo "âŒ ERREUR: Taille supÃ©rieure Ã  10GB"
            exit 1
          fi
          echo "âœ… VÃ©rification terminÃ©e - prÃªt pour dÃ©ploiement"

      - name: âš ï¸ VÃ©rification GitHub Pages
        run: |
          echo "âš ï¸ Si cette Ã©tape Ã©choue avec une erreur 404, GitHub Pages n'est pas activÃ©."
          echo "ğŸ“š Veuillez activer GitHub Pages dans les paramÃ¨tres du repository :"
          echo "   https://github.com/arkalia-luna-system/Arkalia-aria/settings/pages"
          echo "   â†’ Source: 'GitHub Actions'"
          echo ""

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        timeout-minutes: 5
        uses: actions/deploy-pages@v4

      - name: ğŸ“¢ RÃ©sultat du dÃ©ploiement
        if: failure()
        run: |
          echo "âŒ Ã‰chec du dÃ©ploiement GitHub Pages"
          echo ""
          echo "ğŸ”§ SOLUTION :"
          echo "1. Aller sur : https://github.com/arkalia-luna-system/Arkalia-aria/settings/pages"
          echo "2. Dans 'Source', sÃ©lectionner 'GitHub Actions'"
          echo "3. Cliquer sur 'Save'"
          echo "4. Relancer le workflow aprÃ¨s activation"
          echo ""
          echo "ğŸ“– Guide complet : docs/GITHUB_PAGES_SETUP.md"
          exit 1

  notify-deployment:
    name: ğŸ“¢ Notify Deployment
    runs-on: ubuntu-latest
    needs: deploy-docs
    if: always()
    timeout-minutes: 5
    steps:
      - name: ğŸ“¢ Deployment Status
        run: |
          if [[ "${{ needs.deploy-docs.result }}" == "success" ]]; then
            echo "âœ… Documentation deployed successfully!"
            echo "ğŸ“š Documentation has been deployed to GitHub Pages"
          else
            echo "âŒ Documentation deployment failed!"
          fi
