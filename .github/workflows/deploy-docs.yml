name: ğŸ“š Deploy Documentation - GitHub Pages

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    workflow_dispatch:

permissions:
    contents: read
    pages: write
    id-token: write

concurrency:
    group: "pages"
    cancel-in-progress: false

jobs:
    build-docs:
        name: ğŸ“š Build Documentation
        runs-on: ubuntu-latest
        steps:
            - name: ğŸ“¥ Checkout Code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: ğŸ Setup Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"
                  cache: "pip"

            - name: ğŸ“¦ Install Documentation Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install mkdocs mkdocs-material mkdocs-mermaid2-plugin mkdocs-git-revision-date-plugin

            - name: ğŸ“š Build Documentation
              run: |
                  echo "ğŸ“š Building documentation with MkDocs..."
                  mkdocs build --clean --strict

            - name: ğŸ“¤ Upload GitHub Pages artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: site/

    deploy-docs:
        name: ğŸš€ Deploy to GitHub Pages
        runs-on: ubuntu-latest
        needs: build-docs
        if: github.ref == 'refs/heads/main'
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        steps:
            - name: âš ï¸ VÃ©rification GitHub Pages
              run: |
                  echo "âš ï¸ Si cette Ã©tape Ã©choue avec une erreur 404, GitHub Pages n'est pas activÃ©."
                  echo "ğŸ“š Veuillez activer GitHub Pages dans les paramÃ¨tres du repository :"
                  echo "   https://github.com/arkalia-luna-system/Arkalia-aria/settings/pages"
                  echo "   â†’ Source: 'GitHub Actions'"
                  echo ""

            - name: ğŸš€ Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
              with: {}
              continue-on-error: true

            - name: ğŸ“¢ RÃ©sultat du dÃ©ploiement
              if: failure()
              run: |
                  echo "âŒ Ã‰chec du dÃ©ploiement GitHub Pages"
                  echo ""
                  echo "ğŸ”§ SOLUTION :"
                  echo "1. Aller sur : https://github.com/arkalia-luna-system/Arkalia-aria/settings/pages"
                  echo "2. Dans 'Source', sÃ©lectionner 'GitHub Actions'"
                  echo "3. Cliquer sur 'Save'"
                  echo "4. Relancer le workflow aprÃ¨s activation"
                  echo ""
                  echo "ğŸ“– Guide complet : docs/GITHUB_PAGES_SETUP.md"
                  exit 1

    notify-deployment:
        name: ğŸ“¢ Notify Deployment
        runs-on: ubuntu-latest
        needs: deploy-docs
        if: always()
        steps:
            - name: ğŸ“¢ Deployment Status
              run: |
                  if [[ "${{ needs.deploy-docs.result }}" == "success" ]]; then
                    echo "âœ… Documentation deployed successfully!"
                    echo "ğŸ“š Available at: ${{ needs.deploy-docs.outputs.page_url }}"
                  else
                    echo "âŒ Documentation deployment failed!"
                  fi
