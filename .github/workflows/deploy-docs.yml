name: ğŸ“š Deploy Documentation - GitHub Pages

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "deploy-docs-${{ github.ref }}"
  cancel-in-progress: true

# Workflow indÃ©pendant du CI/CD - peut s'exÃ©cuter en parallÃ¨le
# Note: Ce workflow a une prioritÃ© plus basse et ne bloque pas le CI/CD

jobs:
  build-docs:
    name: ğŸ“š Build Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: ğŸ“¦ Install Documentation Dependencies
        timeout-minutes: 5
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material mkdocs-mermaid2-plugin mkdocs-git-revision-date-plugin

      - name: ğŸ“š Build Documentation
        timeout-minutes: 10
        continue-on-error: true
        run: |
          echo "ğŸ“š Building documentation with MkDocs..."
          mkdocs build --clean --strict || (echo "âš ï¸ Documentation build completed with warnings" && exit 0)

      - name: ğŸ§¹ Nettoyer rÃ©pertoire site (supprimer tous les liens)
        if: always()
        run: |
          if [ -d "site" ]; then
            echo "ğŸ§¹ Nettoyage approfondi du rÃ©pertoire site..."
            echo "ğŸ“Š Taille initiale:"
            du -sh site
            
            # CrÃ©er une copie complÃ¨te sans liens symboliques ni physiques
            echo "ğŸ“¦ CrÃ©ation d'une copie propre sans liens..."
            rm -rf site_clean
            mkdir -p site_clean
            
            # Copier tous les fichiers en suivant les liens symboliques (convertir en copies)
            # Utiliser cp -rL pour suivre les liens symboliques et les convertir
            cp -rL site/* site_clean/ 2>/dev/null || cp -r site/* site_clean/ 2>/dev/null || true
            cp -rL site/.[!.]* site_clean/ 2>/dev/null || true
            
            # Supprimer l'ancien rÃ©pertoire et renommer le nouveau
            rm -rf site
            mv site_clean site
            
            # VÃ©rification finale : supprimer tout lien restant
            find site -type l -delete 2>/dev/null || true
            
            # VÃ©rifier qu'il ne reste plus de liens
            SYMLINKS=$(find site -type l 2>/dev/null | wc -l)
            HARD_LINKS=$(find site -type f -links +1 2>/dev/null | wc -l)
            
            if [ "$SYMLINKS" -gt 0 ]; then
              echo "âš ï¸ Attention: $SYMLINKS liens symboliques restants - suppression forcÃ©e..."
              find site -type l -delete
            fi
            
            if [ "$HARD_LINKS" -gt 0 ]; then
              echo "âš ï¸ Attention: $HARD_LINKS fichiers avec liens physiques - conversion..."
              find site -type f -links +1 -exec sh -c 'cp "$1" "$1.tmp" && mv "$1.tmp" "$1"' _ {} \;
            fi
            
            # VÃ©rifier la taille
            SIZE=$(du -sh site | cut -f1)
            SIZE_BYTES=$(du -sb site | cut -f1)
            echo "ğŸ“Š Taille finale: $SIZE ($SIZE_BYTES bytes)"
            
            if [ "$SIZE_BYTES" -gt 1073741824 ]; then
              echo "âš ï¸ Attention: Taille supÃ©rieure Ã  1GB ($SIZE_BYTES bytes)"
            fi
            
            # VÃ©rification finale
            FINAL_SYMLINKS=$(find site -type l 2>/dev/null | wc -l)
            FINAL_HARD_LINKS=$(find site -type f -links +1 2>/dev/null | wc -l)
            
            if [ "$FINAL_SYMLINKS" -eq 0 ] && [ "$FINAL_HARD_LINKS" -eq 0 ]; then
              echo "âœ… Nettoyage terminÃ© - Aucun lien restant"
            else
              echo "âš ï¸ Liens restants: $FINAL_SYMLINKS symboliques, $FINAL_HARD_LINKS physiques"
            fi
          fi

      - name: ğŸ“¤ Upload GitHub Pages artifact
        if: always()
        continue-on-error: true
        uses: actions/upload-pages-artifact@v1
        with:
          path: site/

  deploy-docs:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build-docs]
    if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 10
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: ğŸ§¹ Nettoyage final agressif avant dÃ©ploiement
        run: |
          if [ ! -d "site" ]; then
            echo "âŒ ERREUR: RÃ©pertoire site introuvable aprÃ¨s traitement"
            exit 1
          fi

          echo "ğŸ” Nettoyage final agressif avant dÃ©ploiement..."

          # CrÃ©er une copie complÃ¨te sans aucun lien
          echo "ğŸ“¦ CrÃ©ation d'une copie finale sans liens..."
          rm -rf site_final
          mkdir -p site_final

          # Copier en suivant tous les liens symboliques (les convertir en copies)
          cp -rL site/* site_final/ 2>/dev/null || cp -r site/* site_final/ 2>/dev/null || true

          # Supprimer l'ancien et utiliser le nouveau
          rm -rf site
          mv site_final site

          # Suppression finale de tout lien restant
          find site -type l -delete 2>/dev/null || true

          # VÃ©rifier les liens symboliques
          SYMLINKS=$(find site -type l 2>/dev/null | wc -l)
          if [ "$SYMLINKS" -gt 0 ]; then
            echo "âŒ ERREUR: $SYMLINKS liens symboliques encore prÃ©sents aprÃ¨s nettoyage"
            find site -type l -ls
            exit 1
          fi

          # VÃ©rifier les liens physiques
          HARD_LINKS=$(find site -type f -links +1 2>/dev/null | wc -l)
          if [ "$HARD_LINKS" -gt 0 ]; then
            echo "âš ï¸ $HARD_LINKS fichiers avec liens physiques - conversion finale..."
            find site -type f -links +1 -exec sh -c 'cp "$1" "$1.tmp" && mv "$1.tmp" "$1"' _ {} \;
          fi

          # VÃ©rification finale
          FINAL_SYMLINKS=$(find site -type l 2>/dev/null | wc -l)
          FINAL_HARD_LINKS=$(find site -type f -links +1 2>/dev/null | wc -l)

          if [ "$FINAL_SYMLINKS" -gt 0 ] || [ "$FINAL_HARD_LINKS" -gt 0 ]; then
            echo "âŒ ERREUR: Liens encore prÃ©sents aprÃ¨s nettoyage final"
            echo "   Symboliques: $FINAL_SYMLINKS"
            echo "   Physiques: $FINAL_HARD_LINKS"
            exit 1
          fi

          # VÃ©rifier la taille
          SIZE=$(du -sh site | cut -f1)
          SIZE_BYTES=$(du -sb site | cut -f1)
          echo "ğŸ“Š Taille finale: $SIZE ($SIZE_BYTES bytes)"
          if [ "$SIZE_BYTES" -gt 10737418240 ]; then
            echo "âŒ ERREUR: Taille supÃ©rieure Ã  10GB"
            exit 1
          fi

          echo "âœ… VÃ©rification terminÃ©e - Aucun lien restant, prÃªt pour dÃ©ploiement"

      - name: âš ï¸ VÃ©rification GitHub Pages
        run: |
          echo "âš ï¸ Si cette Ã©tape Ã©choue avec une erreur 404, GitHub Pages n'est pas activÃ©."
          echo "ğŸ“š Veuillez activer GitHub Pages dans les paramÃ¨tres du repository :"
          echo "   https://github.com/arkalia-luna-system/Arkalia-aria/settings/pages"
          echo "   â†’ Source: 'GitHub Actions'"
          echo ""

      - name: ğŸ” VÃ©rification finale avant dÃ©ploiement
        run: |
          echo "ğŸ” VÃ©rification finale du rÃ©pertoire site..."
          if [ ! -d "site" ]; then
            echo "âŒ ERREUR: RÃ©pertoire site introuvable"
            exit 1
          fi
          echo "ğŸ“Š Structure du rÃ©pertoire site:"
          ls -la site/ | head -20
          echo ""
          echo "ğŸ“Š VÃ©rification des fichiers essentiels:"
          [ -f "site/index.html" ] && echo "âœ… index.html prÃ©sent" || echo "âŒ index.html manquant"
          [ -d "site/assets" ] && echo "âœ… assets/ prÃ©sent" || echo "âš ï¸ assets/ manquant"
          echo ""
          echo "ğŸ“Š Taille totale:"
          du -sh site
          echo ""
          echo "âœ… RÃ©pertoire site prÃªt pour dÃ©ploiement"

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        timeout-minutes: 5
        uses: actions/deploy-pages@v4

      - name: ğŸ“¢ RÃ©sultat du dÃ©ploiement
        if: failure()
        run: |
          echo "âŒ Ã‰chec du dÃ©ploiement GitHub Pages"
          echo ""
          echo "ğŸ”§ SOLUTION :"
          echo "1. Aller sur : https://github.com/arkalia-luna-system/Arkalia-aria/settings/pages"
          echo "2. Dans 'Source', sÃ©lectionner 'GitHub Actions'"
          echo "3. Cliquer sur 'Save'"
          echo "4. Relancer le workflow aprÃ¨s activation"
          echo ""
          echo "ğŸ“– Guide complet : docs/GITHUB_PAGES_SETUP.md"
          exit 1

  notify-deployment:
    name: ğŸ“¢ Notify Deployment
    runs-on: ubuntu-latest
    needs: deploy-docs
    if: always()
    timeout-minutes: 5
    steps:
      - name: ğŸ“¢ Deployment Status
        run: |
          if [[ "${{ needs.deploy-docs.result }}" == "success" ]]; then
            echo "âœ… Documentation deployed successfully!"
            echo "ğŸ“š Documentation has been deployed to GitHub Pages"
          else
            echo "âŒ Documentation deployment failed!"
          fi
