<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - ARKALIA ARIA</title>
    <link rel="stylesheet" href="/static/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="/static/dashboard.js"></script>
    <script src="/static/charts.js"></script>
    <script src="/static/exports.js"></script>
</head>

<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="logo-section">
                    <i class="fas fa-heartbeat"></i>
                    <h1>ARKALIA ARIA</h1>
                    <span class="version">v1.0.0</span>
                </div>
                <nav class="main-nav">
                    <a href="/dashboard" class="nav-item">
                        <i class="fas fa-home"></i> Accueil
                    </a>
                    <a href="/dashboard/health" class="nav-item">
                        <i class="fas fa-heart"></i> Santé
                    </a>
                    <a href="/dashboard/pain" class="nav-item active">
                        <i class="fas fa-exclamation-triangle"></i> Douleur
                    </a>
                    <a href="/dashboard/patterns" class="nav-item">
                        <i class="fas fa-chart-line"></i> Patterns
                    </a>
                    <a href="/dashboard/reports" class="nav-item">
                        <i class="fas fa-file-alt"></i> Rapports
                    </a>
                </nav>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="addPainEntry()">
                        <i class="fas fa-plus"></i> Ajouter Douleur
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Pain Overview -->
            <section class="pain-overview">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-exclamation-triangle"></i> Vue d'ensemble Douleur</h3>
                        <div class="period-selector">
                            <select id="pain-period" onchange="updatePainCharts()">
                                <option value="7">7 derniers jours</option>
                                <option value="30" selected>30 derniers jours</option>
                                <option value="90">90 derniers jours</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="pain-metrics-grid">
                            <div class="pain-metric">
                                <div class="metric-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="metric-info">
                                    <div class="metric-value" id="avg-pain-level">--</div>
                                    <div class="metric-label">Niveau Moyen</div>
                                    <div class="metric-unit">/10</div>
                                </div>
                            </div>
                            <div class="pain-metric">
                                <div class="metric-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="metric-info">
                                    <div class="metric-value" id="pain-frequency">--</div>
                                    <div class="metric-label">Fréquence</div>
                                    <div class="metric-unit">épisodes/jour</div>
                                </div>
                            </div>
                            <div class="pain-metric">
                                <div class="metric-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="metric-info">
                                    <div class="metric-value" id="avg-duration">--</div>
                                    <div class="metric-label">Durée Moyenne</div>
                                    <div class="metric-unit">minutes</div>
                                </div>
                            </div>
                            <div class="pain-metric">
                                <div class="metric-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="metric-info">
                                    <div class="metric-value" id="effectiveness">--</div>
                                    <div class="metric-label">Efficacité Traitements</div>
                                    <div class="metric-unit">%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Timeline Interactive D3.js -->
            <section class="timeline-section">
                <div class="chart-container full-width">
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-timeline"></i> Timeline Interactive des Douleurs</h3>
                            <div class="chart-controls">
                                <button class="btn btn-sm btn-secondary" onclick="resetTimelineZoom()">
                                    <i class="fas fa-search-minus"></i> Réinitialiser Zoom
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div id="timeline-container" style="width: 100%; height: 300px; position: relative;">
                                <svg id="timeline-svg" style="width: 100%; height: 100%;"></svg>
                            </div>
                            <div id="timeline-tooltip"
                                style="position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; display: none; pointer-events: none; z-index: 1000;">
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Pain Charts -->
            <section class="pain-charts">
                <div class="chart-row">
                    <div class="chart-container">
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-line"></i> Évolution de la Douleur</h3>
                            </div>
                            <div class="card-content">
                                <canvas id="painEvolutionChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-bar"></i> Répartition par Intensité</h3>
                            </div>
                            <div class="card-content">
                                <canvas id="painIntensityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chart-row">
                    <div class="chart-container">
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-pie"></i> Déclencheurs Physiques</h3>
                            </div>
                            <div class="card-content">
                                <canvas id="physicalTriggersChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-doughnut"></i> Actions Efficaces</h3>
                            </div>
                            <div class="card-content">
                                <canvas id="effectiveActionsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Journal Fields Visualization -->
            <section class="journal-fields">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-book"></i> Détails Journal</h3>
                    </div>
                    <div class="card-content">
                        <div class="journal-grid">
                            <div class="journal-item">
                                <div class="journal-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="journal-info">
                                    <div class="journal-title">Personnes Présentes</div>
                                    <div class="journal-value" id="who-present-summary">--</div>
                                </div>
                            </div>
                            <div class="journal-item">
                                <div class="journal-icon">
                                    <i class="fas fa-comments"></i>
                                </div>
                                <div class="journal-info">
                                    <div class="journal-title">Interactions</div>
                                    <div class="journal-value" id="interactions-summary">--</div>
                                </div>
                            </div>
                            <div class="journal-item">
                                <div class="journal-icon">
                                    <i class="fas fa-heart"></i>
                                </div>
                                <div class="journal-info">
                                    <div class="journal-title">Émotions</div>
                                    <div class="journal-value" id="emotions-summary">--</div>
                                </div>
                            </div>
                            <div class="journal-item">
                                <div class="journal-icon">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <div class="journal-info">
                                    <div class="journal-title">Pensées</div>
                                    <div class="journal-value" id="thoughts-summary">--</div>
                                </div>
                            </div>
                            <div class="journal-item">
                                <div class="journal-icon">
                                    <i class="fas fa-stethoscope"></i>
                                </div>
                                <div class="journal-info">
                                    <div class="journal-title">Symptômes Physiques</div>
                                    <div class="journal-value" id="physical-symptoms-summary">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Pain Patterns -->
            <section class="pain-patterns">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-area"></i> Patterns Temporels</h3>
                        <button class="btn btn-secondary" onclick="analyzePatterns()">
                            <i class="fas fa-search"></i> Analyser
                        </button>
                    </div>
                    <div class="card-content">
                        <div class="patterns-grid">
                            <div class="pattern-item">
                                <div class="pattern-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="pattern-info">
                                    <div class="pattern-title">Heures de Pointe</div>
                                    <div class="pattern-value" id="peak-hours">Analyse en cours...</div>
                                </div>
                            </div>
                            <div class="pattern-item">
                                <div class="pattern-icon">
                                    <i class="fas fa-calendar-week"></i>
                                </div>
                                <div class="pattern-info">
                                    <div class="pattern-title">Jours de la Semaine</div>
                                    <div class="pattern-value" id="weekday-pattern">Analyse en cours...</div>
                                </div>
                            </div>
                            <div class="pattern-item">
                                <div class="pattern-icon">
                                    <i class="fas fa-cloud-rain"></i>
                                </div>
                                <div class="pattern-info">
                                    <div class="pattern-title">Corrélation Météo</div>
                                    <div class="pattern-value" id="weather-correlation">Analyse en cours...</div>
                                </div>
                            </div>
                            <div class="pattern-item">
                                <div class="pattern-icon">
                                    <i class="fas fa-moon"></i>
                                </div>
                                <div class="pattern-info">
                                    <div class="pattern-title">Corrélation Sommeil</div>
                                    <div class="pattern-value" id="sleep-correlation">Analyse en cours...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Corrélations Interactives -->
            <section class="correlations-section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-project-diagram"></i> Corrélations Interactives</h3>
                        <div class="period-selector">
                            <select id="correlation-period" onchange="loadCorrelationCharts()">
                                <option value="7">7 derniers jours</option>
                                <option value="30" selected>30 derniers jours</option>
                                <option value="90">90 derniers jours</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="chart-row">
                            <div class="chart-container">
                                <div class="chart-wrapper">
                                    <h4><i class="fas fa-moon"></i> Corrélation Sommeil-Douleur</h4>
                                    <canvas id="sleepPainCorrelationChart"></canvas>
                                    <div class="chart-info" id="sleepPainCorrelationInfo">
                                        <p>Chargement des données...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <div class="chart-wrapper">
                                    <h4><i class="fas fa-stress"></i> Corrélation Stress-Douleur</h4>
                                    <canvas id="stressPainCorrelationChart"></canvas>
                                    <div class="chart-info" id="stressPainCorrelationInfo">
                                        <p>Chargement des données...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container full-width" style="margin-top: 20px;">
                            <div class="chart-wrapper">
                                <h4><i class="fas fa-th"></i> Heatmap des Corrélations</h4>
                                <canvas id="correlationHeatmapChart" style="max-height: 400px;"></canvas>
                                <div class="chart-info" id="correlationHeatmapInfo">
                                    <p>Chargement des données...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Pain Entries Table -->
            <section class="pain-entries-table">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-table"></i> Entrées de Douleur</h3>
                        <div class="table-controls">
                            <div class="export-buttons">
                                <button class="btn btn-secondary" onclick="exportPainData('excel')"
                                    title="Exporter en Excel">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                                <button class="btn btn-secondary" onclick="exportPainData('pdf')"
                                    title="Exporter en PDF">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <button class="btn btn-secondary" onclick="exportPainData('html')"
                                    title="Exporter en HTML">
                                    <i class="fas fa-file-code"></i> HTML
                                </button>
                                <button class="btn btn-secondary" onclick="exportPainData('json')"
                                    title="Exporter en JSON">
                                    <i class="fas fa-file-code"></i> JSON
                                </button>
                            </div>
                            <button class="btn btn-primary" onclick="addPainEntry()">
                                <i class="fas fa-plus"></i> Nouvelle Entrée
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="table-filters">
                            <input type="date" id="pain-filter-date-start" onchange="filterPainEntries()"
                                placeholder="Date début">
                            <input type="date" id="pain-filter-date-end" onchange="filterPainEntries()"
                                placeholder="Date fin">
                            <select id="pain-filter-intensity" onchange="filterPainEntries()">
                                <option value="">Toutes les intensités</option>
                                <option value="0-3">Faible (0-3)</option>
                                <option value="4-6">Modérée (4-6)</option>
                                <option value="7-10">Forte (7-10)</option>
                            </select>
                            <select id="pain-filter-location" onchange="filterPainEntries()">
                                <option value="">Toutes les localisations</option>
                            </select>
                            <select id="pain-filter-trigger" onchange="filterPainEntries()">
                                <option value="">Tous les déclencheurs</option>
                                <option value="stress">Stress</option>
                                <option value="fatigue">Fatigue</option>
                                <option value="activité">Activité</option>
                            </select>
                            <input type="text" id="pain-filter-who-present" onchange="filterPainEntries()"
                                placeholder="Personnes présentes">
                        </div>

                        <div class="table-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date/Heure</th>
                                        <th>Intensité</th>
                                        <th>Déclencheur Physique</th>
                                        <th>Déclencheur Mental</th>
                                        <th>Activité</th>
                                        <th>Localisation</th>
                                        <th>Action</th>
                                        <th>Efficacité</th>
                                        <th>Personnes Présentes</th>
                                        <th>Interactions</th>
                                        <th>Émotions</th>
                                        <th>Pensées</th>
                                        <th>Symptômes Physiques</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pain-entries-body">
                                    <tr>
                                        <td colspan="14" class="loading">Chargement des données...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Pain Insights -->
            <section class="pain-insights">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-lightbulb"></i> Insights et Recommandations</h3>
                        <button class="btn btn-secondary" onclick="generateInsights()">
                            <i class="fas fa-magic"></i> Générer
                        </button>
                    </div>
                    <div class="card-content">
                        <div class="insights-list" id="pain-insights-list">
                            <div class="insight-item">
                                <div class="insight-icon">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div class="insight-content">
                                    <div class="insight-title">Analyse en cours...</div>
                                    <div class="insight-description">Les insights seront générés après l'analyse des
                                        données</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Pain Entry Modal -->
    <div class="modal" id="pain-entry-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus"></i> Nouvelle Entrée de Douleur</h3>
                <button class="modal-close" onclick="closePainModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="pain-entry-form">
                    <div class="form-group">
                        <label for="pain-intensity">Intensité (0-10)</label>
                        <input type="range" id="pain-intensity" min="0" max="10" value="5"
                            oninput="updateIntensityDisplay(this.value)">
                        <div class="intensity-display">
                            <span id="intensity-value">5</span>/10
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="physical-trigger">Déclencheur Physique</label>
                        <select id="physical-trigger">
                            <option value="">Sélectionner...</option>
                            <option value="stress">Stress</option>
                            <option value="fatigue">Fatigue</option>
                            <option value="activité">Activité physique</option>
                            <option value="position">Position</option>
                            <option value="météo">Météo</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="mental-trigger">Déclencheur Mental</label>
                        <input type="text" id="mental-trigger" placeholder="Stress, anxiété, etc.">
                    </div>

                    <div class="form-group">
                        <label for="activity">Activité</label>
                        <input type="text" id="activity" placeholder="Travail, repos, etc.">
                    </div>

                    <div class="form-group">
                        <label for="location">Localisation</label>
                        <input type="text" id="location" placeholder="Tête, dos, etc.">
                    </div>

                    <div class="form-group">
                        <label for="action-taken">Action Entreprise</label>
                        <input type="text" id="action-taken" placeholder="Médication, respiration, etc.">
                    </div>

                    <div class="form-group">
                        <label for="effectiveness">Efficacité (0-10)</label>
                        <input type="range" id="effectiveness" min="0" max="10" value="5"
                            oninput="updateEffectivenessDisplay(this.value)">
                        <div class="effectiveness-display">
                            <span id="effectiveness-value">5</span>/10
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" rows="3" placeholder="Notes supplémentaires..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="who-present">Personnes Présentes</label>
                        <input type="text" id="who-present" placeholder="Famille, amis, collègues, etc.">
                    </div>

                    <div class="form-group">
                        <label for="interactions">Interactions</label>
                        <textarea id="interactions" rows="2"
                            placeholder="Qui dit/fait quoi - interactions observées"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="emotions">Émotions</label>
                        <input type="text" id="emotions" placeholder="Anxiété, frustration, tristesse, etc.">
                    </div>

                    <div class="form-group">
                        <label for="thoughts">Pensées</label>
                        <textarea id="thoughts" rows="2"
                            placeholder="Ce que je pense - pensées et réflexions"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="physical-symptoms">Symptômes Physiques</label>
                        <input type="text" id="physical-symptoms" placeholder="Tension musculaire, maux de tête, etc.">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePainModal()">Annuler</button>
                <button class="btn btn-primary" onclick="submitPainEntry()">
                    <i class="fas fa-save"></i> Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Initialisation de la page douleur
        document.addEventListener('DOMContentLoaded', function () {
            loadPainData();
            updatePainCharts();
            loadPainEntries();
            loadCorrelationCharts();
            analyzePatterns();
            initializeTimeline();
        });

        function loadPainData() {
            fetch('/api/pain/entries/recent?limit=100')
                .then(response => response.json())
                .then(data => {
                    updatePainMetrics(data);
                })
                .catch(error => {
                    console.error('Error loading pain data:', error);
                });
        }

        function updatePainMetrics(data) {
            if (data.length === 0) return;

            // Calculer les métriques
            const avgIntensity = data.reduce((sum, entry) => sum + entry.intensity, 0) / data.length;
            const frequency = data.length / 30; // Entrées par jour sur 30 jours
            const avgEffectiveness = data
                .filter(entry => entry.effectiveness !== null)
                .reduce((sum, entry) => sum + entry.effectiveness, 0) /
                data.filter(entry => entry.effectiveness !== null).length;

            document.getElementById('avg-pain-level').textContent = avgIntensity.toFixed(1);
            document.getElementById('pain-frequency').textContent = frequency.toFixed(1);
            document.getElementById('effectiveness').textContent =
                avgEffectiveness ? avgEffectiveness.toFixed(0) + '%' : '--';

            // Mettre à jour les résumés des champs journal
            const whoPresentCount = data.filter(entry => entry.who_present).length;
            const interactionsCount = data.filter(entry => entry.interactions).length;
            const emotionsCount = data.filter(entry => entry.emotions).length;
            const thoughtsCount = data.filter(entry => entry.thoughts).length;
            const symptomsCount = data.filter(entry => entry.physical_symptoms).length;

            document.getElementById('who-present-summary').textContent = `${whoPresentCount} entrées`;
            document.getElementById('interactions-summary').textContent = `${interactionsCount} entrées`;
            document.getElementById('emotions-summary').textContent = `${emotionsCount} entrées`;
            document.getElementById('thoughts-summary').textContent = `${thoughtsCount} entrées`;
            document.getElementById('physical-symptoms-summary').textContent = `${symptomsCount} entrées`;
        }

        function updatePainCharts() {
            const period = document.getElementById('pain-period').value;

            fetch(`/api/pain/entries/recent?limit=${period * 10}`)
                .then(response => response.json())
                .then(data => {
                    updatePainEvolutionChart(data);
                    updatePainIntensityChart(data);
                    updatePhysicalTriggersChart(data);
                    updateEffectiveActionsChart(data);
                })
                .catch(error => {
                    console.error('Error loading pain chart data:', error);
                });
        }

        function updatePainEvolutionChart(data) {
            const ctx = document.getElementById('painEvolutionChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.timestamp).toLocaleDateString()),
                    datasets: [{
                        label: 'Intensité de la Douleur',
                        data: data.map(d => d.intensity),
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10
                        }
                    }
                }
            });
        }

        function updatePainIntensityChart(data) {
            const intensityCounts = {};
            data.forEach(entry => {
                const intensity = entry.intensity;
                intensityCounts[intensity] = (intensityCounts[intensity] || 0) + 1;
            });

            const ctx = document.getElementById('painIntensityChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(intensityCounts),
                    datasets: [{
                        label: 'Nombre d\'épisodes',
                        data: Object.values(intensityCounts),
                        backgroundColor: '#3498db'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updatePhysicalTriggersChart(data) {
            const triggerCounts = {};
            data.forEach(entry => {
                if (entry.physical_trigger) {
                    triggerCounts[entry.physical_trigger] = (triggerCounts[entry.physical_trigger] || 0) + 1;
                }
            });

            const ctx = document.getElementById('physicalTriggersChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(triggerCounts),
                    datasets: [{
                        data: Object.values(triggerCounts),
                        backgroundColor: [
                            '#e74c3c',
                            '#3498db',
                            '#2ecc71',
                            '#f39c12',
                            '#9b59b6',
                            '#1abc9c'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        function updateEffectiveActionsChart(data) {
            const actionCounts = {};
            data.forEach(entry => {
                if (entry.action_taken && entry.effectiveness > 5) {
                    actionCounts[entry.action_taken] = (actionCounts[entry.action_taken] || 0) + 1;
                }
            });

            const ctx = document.getElementById('effectiveActionsChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(actionCounts),
                    datasets: [{
                        data: Object.values(actionCounts),
                        backgroundColor: [
                            '#2ecc71',
                            '#3498db',
                            '#f39c12',
                            '#e74c3c'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        function loadPainEntries() {
            fetch('/api/pain/entries/recent?limit=100')
                .then(response => response.json())
                .then(data => {
                    updatePainEntriesTable(data);
                })
                .catch(error => {
                    console.error('Error loading pain entries:', error);
                });
        }

        function updatePainEntriesTable(data) {
            const tbody = document.getElementById('pain-entries-body');
            tbody.innerHTML = '';

            // Stocker les données pour l'export
            filteredPainEntries = data;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" class="no-data">Aucune entrée de douleur</td></tr>';
                return;
            }

            data.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(entry.timestamp).toLocaleString()}</td>
                    <td><span class="intensity-badge intensity-${entry.intensity}">${entry.intensity}</span></td>
                    <td>${entry.physical_trigger || '--'}</td>
                    <td>${entry.mental_trigger || '--'}</td>
                    <td>${entry.activity || '--'}</td>
                    <td>${entry.location || '--'}</td>
                    <td>${entry.action_taken || '--'}</td>
                    <td>${entry.effectiveness ? entry.effectiveness + '/10' : '--'}</td>
                    <td>${entry.who_present || '--'}</td>
                    <td>${entry.interactions || '--'}</td>
                    <td>${entry.emotions || '--'}</td>
                    <td>${entry.thoughts || '--'}</td>
                    <td>${entry.physical_symptoms || '--'}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editPainEntry(${entry.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deletePainEntry(${entry.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function addPainEntry() {
            document.getElementById('pain-entry-modal').style.display = 'flex';
        }

        function closePainModal() {
            document.getElementById('pain-entry-modal').style.display = 'none';
            document.getElementById('pain-entry-form').reset();
        }

        function updateIntensityDisplay(value) {
            document.getElementById('intensity-value').textContent = value;
        }

        function updateEffectivenessDisplay(value) {
            document.getElementById('effectiveness-value').textContent = value;
        }

        function submitPainEntry() {
            const formData = {
                intensity: parseInt(document.getElementById('pain-intensity').value),
                physical_trigger: document.getElementById('physical-trigger').value || null,
                mental_trigger: document.getElementById('mental-trigger').value || null,
                activity: document.getElementById('activity').value || null,
                location: document.getElementById('location').value || null,
                action_taken: document.getElementById('action-taken').value || null,
                effectiveness: document.getElementById('effectiveness').value ? parseInt(document.getElementById('effectiveness').value) : null,
                notes: document.getElementById('notes').value || null,
                who_present: document.getElementById('who-present').value || null,
                interactions: document.getElementById('interactions').value || null,
                emotions: document.getElementById('emotions').value || null,
                thoughts: document.getElementById('thoughts').value || null,
                physical_symptoms: document.getElementById('physical-symptoms').value || null
            };

            fetch('/api/pain/entry', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    closePainModal();
                    showNotification('Entrée de douleur enregistrée', 'success');
                    loadPainData();
                    updatePainCharts();
                    loadPainEntries();
                })
                .catch(error => {
                    showNotification('Erreur lors de l\'enregistrement', 'error');
                    console.error('Error:', error);
                });
        }

        let sleepPainChart = null;
        let stressPainChart = null;
        let correlationHeatmapChart = null;
        let filteredPainEntries = []; // Stocke les données filtrées pour l'export
        let timelineZoom = null; // Zoom D3 pour la timeline

        function loadCorrelationCharts() {
            const days = document.getElementById('correlation-period')?.value || 30;

            // Charger corrélation sommeil-douleur
            fetch(`/api/patterns/correlations/sleep-pain?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    const canvas = document.getElementById('sleepPainCorrelationChart');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        if (sleepPainChart) {
                            sleepPainChart.destroy();
                        }
                        sleepPainChart = createSleepPainCorrelationChart('sleepPainCorrelationChart', {
                            correlation: data.correlation || 0,
                            sleep_data: data.sleep_data || [],
                            pain_data: data.pain_data || []
                        });
                        const info = document.getElementById('sleepPainCorrelationInfo');
                        if (info) {
                            const corr = data.correlation || 0;
                            let interpretation = '';
                            if (Math.abs(corr) > 0.7) {
                                interpretation = 'Corrélation forte';
                            } else if (Math.abs(corr) > 0.4) {
                                interpretation = 'Corrélation modérée';
                            } else {
                                interpretation = 'Corrélation faible';
                            }
                            info.innerHTML = `<p><strong>Corrélation:</strong> ${corr.toFixed(3)} - ${interpretation}</p>`;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading sleep-pain correlation:', error);
                    const info = document.getElementById('sleepPainCorrelationInfo');
                    if (info) {
                        info.innerHTML = '<p>Erreur lors du chargement des données</p>';
                    }
                });

            // Charger corrélation stress-douleur
            fetch(`/api/patterns/correlations/stress-pain?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    const canvas = document.getElementById('stressPainCorrelationChart');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        if (stressPainChart) {
                            stressPainChart.destroy();
                        }
                        stressPainChart = createStressPainCorrelationChart('stressPainCorrelationChart', {
                            correlation: data.correlation || 0,
                            stress_data: data.stress_data || [],
                            pain_data: data.pain_data || []
                        });
                        const info = document.getElementById('stressPainCorrelationInfo');
                        if (info) {
                            const corr = data.correlation || 0;
                            let interpretation = '';
                            if (Math.abs(corr) > 0.7) {
                                interpretation = 'Corrélation forte';
                            } else if (Math.abs(corr) > 0.4) {
                                interpretation = 'Corrélation modérée';
                            } else {
                                interpretation = 'Corrélation faible';
                            }
                            info.innerHTML = `<p><strong>Corrélation:</strong> ${corr.toFixed(3)} - ${interpretation}</p>`;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading stress-pain correlation:', error);
                    const info = document.getElementById('stressPainCorrelationInfo');
                    if (info) {
                        info.innerHTML = '<p>Erreur lors du chargement des données</p>';
                    }
                });

            // Charger heatmap des corrélations
            Promise.all([
                fetch(`/api/patterns/correlations/sleep-pain?days=${days}`).then(r => r.json()),
                fetch(`/api/patterns/correlations/stress-pain?days=${days}`).then(r => r.json())
            ])
                .then(([sleepData, stressData]) => {
                    const canvas = document.getElementById('correlationHeatmapChart');
                    if (canvas && window.createCorrelationHeatmap) {
                        if (correlationHeatmapChart) {
                            correlationHeatmapChart.destroy();
                        }

                        // Construire la matrice de corrélations
                        const matrix = [
                            [1.0, sleepData.correlation || 0, stressData.correlation || 0, 0.0], // Douleur
                            [sleepData.correlation || 0, 1.0, 0.0, 0.0], // Sommeil
                            [stressData.correlation || 0, 0.0, 1.0, 0.0], // Stress
                            [0.0, 0.0, 0.0, 1.0] // Activité (placeholder)
                        ];

                        correlationHeatmapChart = createCorrelationHeatmap('correlationHeatmapChart', {
                            matrix: matrix,
                            labels: ['Douleur', 'Sommeil', 'Stress', 'Activité']
                        });

                        const info = document.getElementById('correlationHeatmapInfo');
                        if (info) {
                            info.innerHTML = '<p><strong>Heatmap des corrélations</strong> - Les valeurs proches de 1 indiquent une corrélation forte</p>';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading correlation heatmap:', error);
                    const info = document.getElementById('correlationHeatmapInfo');
                    if (info) {
                        info.innerHTML = '<p>Erreur lors du chargement du heatmap</p>';
                    }
                });
        }

        function analyzePatterns() {
            // Implémenter l'analyse des patterns
            document.getElementById('peak-hours').textContent = '14h-16h';
            document.getElementById('weekday-pattern').textContent = 'Lundi-Vendredi';
            document.getElementById('weather-correlation').textContent = 'Corrélation faible';
            document.getElementById('sleep-correlation').textContent = 'Corrélation forte';
        }

        function generateInsights() {
            // Implémenter la génération d'insights
            const insightsList = document.getElementById('pain-insights-list');
            insightsList.innerHTML = `
                <div class="insight-item">
                    <div class="insight-icon">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div class="insight-content">
                        <div class="insight-title">Pattern Temporel Détecté</div>
                        <div class="insight-description">Vos épisodes de douleur sont plus fréquents entre 14h et 16h. Considérez des pauses préventives.</div>
                    </div>
                </div>
                <div class="insight-item">
                    <div class="insight-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="insight-content">
                        <div class="insight-title">Traitement Efficace</div>
                        <div class="insight-description">La respiration profonde est votre traitement le plus efficace (8.2/10).</div>
                    </div>
                </div>
            `;
        }

        /**
         * Exporte les données de douleur dans le format spécifié
         * Utilise les filtres actuels appliqués
         */
        async function exportPainData(format = 'excel') {
            try {
                // S'assurer que ARIAExports est disponible
                if (!window.ARIAExports) {
                    showNotification('Erreur: Module d\'export non chargé', 'error');
                    return;
                }

                // Récupérer les données filtrées ou toutes les données
                let dataToExport = filteredPainEntries.length > 0 ? filteredPainEntries : [];

                // Si pas de données filtrées, charger toutes les données
                if (dataToExport.length === 0) {
                    const response = await fetch('/api/pain/entries/recent?limit=1000');
                    const allData = await response.json();
                    dataToExport = allData;
                }

                // Préparer les données pour l'export
                const exportData = {
                    timestamp: new Date().toISOString(),
                    title: 'Données de Douleur ARKALIA ARIA',
                    pain: dataToExport,
                    filters: {
                        date_start: document.getElementById('pain-filter-date-start')?.value || null,
                        date_end: document.getElementById('pain-filter-date-end')?.value || null,
                        intensity: document.getElementById('pain-filter-intensity')?.value || null,
                        location: document.getElementById('pain-filter-location')?.value || null,
                        trigger: document.getElementById('pain-filter-trigger')?.value || null,
                        who_present: document.getElementById('pain-filter-who-present')?.value || null
                    },
                    summary: {
                        total_entries: dataToExport.length,
                        date_range: dataToExport.length > 0 ? {
                            start: dataToExport[dataToExport.length - 1]?.timestamp,
                            end: dataToExport[0]?.timestamp
                        } : null
                    }
                };

                // Options d'export selon le format
                const options = {
                    filename: `aria-pain-data-${new Date().toISOString().split('T')[0]}.${format}`,
                    includeCharts: false,
                    includeInsights: true,
                    includeRecommendations: false
                };

                // Exporter selon le format
                switch (format.toLowerCase()) {
                    case 'excel':
                        await window.ARIAExports.exportToExcel(exportData, options);
                        break;
                    case 'pdf':
                        await window.ARIAExports.exportToPDF(exportData, options);
                        break;
                    case 'html':
                        await window.ARIAExports.exportToHTML(exportData, options);
                        break;
                    case 'json':
                        await window.ARIAExports.exportToJSON(exportData, options);
                        break;
                    default:
                        showNotification(`Format non supporté: ${format}`, 'error');
                        return;
                }

                showNotification(`Export ${format.toUpperCase()} réussi`, 'success');

            } catch (error) {
                showNotification('Erreur d\'export: ' + error.message, 'error');
                console.error('Error exporting pain data:', error);
            }
        }

        function filterPainEntries() {
            const intensityFilter = document.getElementById('pain-filter-intensity').value;
            const locationFilter = document.getElementById('pain-filter-location').value;
            const triggerFilter = document.getElementById('pain-filter-trigger').value;
            const whoPresentFilter = document.getElementById('pain-filter-who-present').value;
            const dateStart = document.getElementById('pain-filter-date-start').value;
            const dateEnd = document.getElementById('pain-filter-date-end').value;

            fetch('/api/pain/entries/recent?limit=100')
                .then(response => response.json())
                .then(data => {
                    let filtered = data;

                    // Filtrer par intensité
                    if (intensityFilter) {
                        const [min, max] = intensityFilter.split('-').map(Number);
                        filtered = filtered.filter(entry => entry.intensity >= min && entry.intensity <= max);
                    }

                    // Filtrer par localisation
                    if (locationFilter) {
                        filtered = filtered.filter(entry => entry.location && entry.location.toLowerCase().includes(locationFilter.toLowerCase()));
                    }

                    // Filtrer par déclencheur
                    if (triggerFilter) {
                        filtered = filtered.filter(entry =>
                            (entry.physical_trigger && entry.physical_trigger.toLowerCase().includes(triggerFilter.toLowerCase())) ||
                            (entry.mental_trigger && entry.mental_trigger.toLowerCase().includes(triggerFilter.toLowerCase()))
                        );
                    }

                    // Filtrer par personnes présentes
                    if (whoPresentFilter) {
                        filtered = filtered.filter(entry => entry.who_present && entry.who_present.toLowerCase().includes(whoPresentFilter.toLowerCase()));
                    }

                    // Filtrer par date
                    if (dateStart) {
                        filtered = filtered.filter(entry => new Date(entry.timestamp) >= new Date(dateStart));
                    }
                    if (dateEnd) {
                        filtered = filtered.filter(entry => new Date(entry.timestamp) <= new Date(dateEnd + 'T23:59:59'));
                    }

                    // Stocker les données filtrées pour l'export
                    filteredPainEntries = filtered;
                    updatePainEntriesTable(filtered);
                })
                .catch(error => {
                    console.error('Error filtering pain entries:', error);
                });
        }

        /**
         * Initialise la timeline interactive D3.js
         */
        function initializeTimeline() {
            fetch('/api/pain/entries/recent?limit=1000')
                .then(response => response.json())
                .then(data => {
                    createInteractiveTimeline(data);
                })
                .catch(error => {
                    console.error('Error loading timeline data:', error);
                });
        }

        /**
         * Crée une timeline interactive avec D3.js
         */
        function createInteractiveTimeline(data) {
            if (!data || data.length === 0) {
                return;
            }

            // Nettoyer le SVG précédent
            d3.select('#timeline-svg').selectAll('*').remove();

            const margin = { top: 20, right: 30, bottom: 40, left: 50 };
            const container = document.getElementById('timeline-container');
            if (!container) return;

            const width = container.clientWidth - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            // Parser les dates
            const parseDate = d3.timeParse('%Y-%m-%dT%H:%M:%S');
            data.forEach(d => {
                d.date = parseDate(d.timestamp) || new Date(d.timestamp);
                d.intensity = +d.intensity || 0;
            });

            // Trier par date
            data.sort((a, b) => a.date - b.date);

            // Échelles
            const xScale = d3.scaleTime()
                .domain(d3.extent(data, d => d.date))
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([0, 10])
                .range([height, 0]);

            // Zoom
            const zoom = d3.zoom()
                .scaleExtent([0.5, 10])
                .extent([[0, 0], [width, height]])
                .on('zoom', (event) => {
                    const newXScale = event.transform.rescaleX(xScale);
                    xAxisGroup.call(xAxis.scale(newXScale));
                    updateTimelinePoints(newXScale, yScale, data);
                });

            // SVG
            const svg = d3.select('#timeline-svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Axes
            const xAxis = d3.axisBottom(xScale)
                .ticks(d3.timeDay.every(1))
                .tickFormat(d3.timeFormat('%d/%m'));

            const yAxis = d3.axisLeft(yScale)
                .ticks(10);

            const xAxisGroup = g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(xAxis);

            g.append('g')
                .call(yAxis);

            // Ligne de tendance
            const line = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.intensity))
                .curve(d3.curveMonotoneX);

            g.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', '#e74c3c')
                .attr('stroke-width', 2)
                .attr('d', line);

            // Points interactifs
            const points = g.selectAll('.pain-point')
                .data(data)
                .enter()
                .append('circle')
                .attr('class', 'pain-point')
                .attr('cx', d => xScale(d.date))
                .attr('cy', d => yScale(d.intensity))
                .attr('r', 4)
                .attr('fill', d => {
                    if (d.intensity >= 7) return '#e74c3c';
                    if (d.intensity >= 4) return '#f39c12';
                    return '#2ecc71';
                })
                .attr('stroke', '#fff')
                .attr('stroke-width', 1)
                .style('cursor', 'pointer')
                .on('mouseover', function (event, d) {
                    d3.select(this).attr('r', 6);
                    showTimelineTooltip(event, d);
                })
                .on('mouseout', function () {
                    d3.select(this).attr('r', 4);
                    hideTimelineTooltip();
                })
                .on('click', function (event, d) {
                    console.log('Pain entry clicked:', d);
                });

            // Appliquer le zoom
            g.call(zoom);

            // Stocker le zoom pour réinitialisation
            timelineZoom = zoom;

            // Fonction pour mettre à jour les points lors du zoom
            function updateTimelinePoints(xScale, yScale, data) {
                points
                    .attr('cx', d => xScale(d.date))
                    .attr('cy', d => yScale(d.intensity));

                g.select('path')
                    .attr('d', line.x(d => xScale(d.date)).y(d => yScale(d.intensity)));
            }
        }

        /**
         * Affiche le tooltip de la timeline
         */
        function showTimelineTooltip(event, data) {
            const tooltip = document.getElementById('timeline-tooltip');
            if (!tooltip) return;
            const date = new Date(data.timestamp).toLocaleString('fr-FR');
            tooltip.innerHTML = `
                <strong>${date}</strong><br>
                Intensité: ${data.intensity}/10<br>
                ${data.location ? `Localisation: ${data.location}<br>` : ''}
                ${data.physical_trigger ? `Déclencheur: ${data.physical_trigger}` : ''}
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }

        /**
         * Cache le tooltip de la timeline
         */
        function hideTimelineTooltip() {
            const tooltip = document.getElementById('timeline-tooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }

        /**
         * Réinitialise le zoom de la timeline
         */
        function resetTimelineZoom() {
            if (timelineZoom) {
                d3.select('#timeline-svg g').transition().call(
                    timelineZoom.transform,
                    d3.zoomIdentity
                );
            }
            initializeTimeline();
        }
    </script>
</body>

</html>